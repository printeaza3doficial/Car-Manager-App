<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panou de control Mașini</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen p-4 flex flex-col items-center font-sans">

    <!-- Container principal -->
    <div class="w-full max-w-5xl bg-white rounded-xl shadow-lg p-6 md:p-8">
        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Panou de control Mașini</h1>
            <p id="infoMessage" class="text-gray-600 mt-2">Gestionează și urmărește scadențele importante ale vehiculelor tale.</p>
        </header>

        <div class="flex justify-end gap-2 mb-4">
            <!-- Butonul Adaugă Mașină deschide acum fișierul de date pentru a-l edita manual -->
            <a href="data.json" class="flex items-center px-4 py-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition-colors shadow-md">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
                Adaugă/Editează Mașină
            </a>
        </div>

        <!-- Tabel cu datele mașinilor -->
        <div class="overflow-x-auto rounded-lg shadow-sm">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nr. Înmatriculare</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Marcă</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Model</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ITP</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rovinietă</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">RCA</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acțiuni</th>
                    </tr>
                </thead>
                <tbody id="carTableBody" class="bg-white divide-y divide-gray-200">
                    <tr><td colspan="7" class="p-4 text-center text-gray-500">Se încarcă mașinile...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Functia pentru a crea un memento in calendar
        window.setReminder = (inmatriculare, marca, itpDate, rovinietaDate, rcaDate) => {
            const events = [];

            if (itpDate && itpDate !== 'N/A' && itpDate.split('-').length === 3) {
                events.push({
                    title: `ITP - ${inmatriculare}`,
                    date: itpDate,
                    description: `ITP-ul masinii ${marca} (${inmatriculare}) expiră.`,
                });
            }
            if (rovinietaDate && rovinietaDate !== 'N/A' && rovinietaDate.split('-').length === 3) {
                events.push({
                    title: `Rovinieta - ${inmatriculare}`,
                    date: rovinietaDate,
                    description: `Rovinieta masinii ${marca} (${inmatriculare}) expiră.`,
                });
            }
            if (rcaDate && rcaDate !== 'N/A' && rcaDate.split('-').length === 3) {
                events.push({
                    title: `RCA - ${inmatriculare}`,
                    date: rcaDate,
                    description: `RCA-ul masinii ${marca} (${inmatriculare}) expiră.`,
                });
            }
            if (events.length === 0) {
                console.log("Nu există date de expirare valide pentru a crea memento-uri.");
                return;
            }

            const downloadLink = document.createElement('a');
            let icsContent = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Calendar reminder//EN\n";
            events.forEach(event => {
                const reminderDate = new Date(event.date);
                icsContent += "BEGIN:VEVENT\n";
                icsContent += `DTSTART;VALUE=DATE:${reminderDate.getFullYear()}${('0' + (reminderDate.getMonth() + 1)).slice(-2)}${('0' + reminderDate.getDate()).slice(-2)}\n`;
                icsContent += `DTEND;VALUE=DATE:${reminderDate.getFullYear()}${('0' + (reminderDate.getMonth() + 1)).slice(-2)}${('0' + reminderDate.getDate()).slice(-2)}\n`;
                icsContent += `SUMMARY:${event.title}\n`;
                icsContent += `DESCRIPTION:${event.description}\n`;
                icsContent += "END:VEVENT\n";
            });
            icsContent += "END:VCALENDAR";

            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            downloadLink.href = url;
            downloadLink.download = `mementouri-${inmatriculare}.ics`;
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            URL.revokeObjectURL(url);
            console.log("Fișierul .ics a fost generat și descărcat. Importă-l în calendarul tău.");
        };

        // Functia pentru a popula tabelul cu datele din data.json
        window.onload = async () => {
            const tableBody = document.getElementById('carTableBody');
            tableBody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-gray-500">Se încarcă mașinile...</td></tr>';

            try {
                const response = await fetch('data.json');
                if (!response.ok) {
                    throw new Error(`Eroare HTTP: ${response.status}`);
                }
                const cars = await response.json();
                
                tableBody.innerHTML = '';
                if (cars.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-gray-500">Nu ai adăugat încă mașini. Editează fișierul data.json pentru a începe.</td></tr>';
                } else {
                    const today = new Date();
                    cars.forEach(car => {
                        const row = document.createElement('tr');
                        let rowColorClass = '';
                        
                        const itpDate = car.itp ? new Date(car.itp) : null;
                        const rovinietaDate = car.rovinieta ? new Date(car.rovinieta) : null;
                        const rcaDate = car.rca ? new Date(car.rca) : null;

                        const formatDate = (dateString) => {
                            if (!dateString) return 'N/A';
                            const date = new Date(dateString);
                            const formattedDate = date.toLocaleDateString('ro-RO');
                            const timeDifference = date.getTime() - today.getTime();
                            const daysLeft = Math.ceil(timeDifference / (1000 * 60 * 60 * 24));
                            
                            if (daysLeft <= 0) {
                                return `<span class="font-bold text-red-600">${formattedDate} (EXPIRAT!)</span>`;
                            }
                            if (daysLeft <= 30) {
                                return `<span class="font-bold text-yellow-600">${formattedDate} (${daysLeft} zile)</span>`;
                            }
                            return formattedDate;
                        };
                        
                        const isExpired = (date) => date && date.getTime() < today.getTime();
                        const isUrgent = (date) => {
                            if (!date) return false;
                            const timeDifference = date.getTime() - today.getTime();
                            const daysLeft = Math.ceil(timeDifference / (1000 * 60 * 60 * 24));
                            return daysLeft > 0 && daysLeft <= 30;
                        };

                        if (isExpired(itpDate) || isExpired(rovinietaDate) || isExpired(rcaDate)) {
                            rowColorClass = 'bg-red-100';
                        } else if (isUrgent(itpDate) || isUrgent(rovinietaDate) || isUrgent(rcaDate)) {
                            rowColorClass = 'bg-yellow-50';
                        }

                        row.className = `${rowColorClass} hover:bg-gray-100 transition-colors`;
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">${car.inmatriculare}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${car.marca}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${car.model}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${formatDate(car.itp)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${formatDate(car.rovinieta)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${formatDate(car.rca)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <button onclick="setReminder('${car.inmatriculare}', '${car.marca}', '${car.itp}', '${car.rovinieta}', '${car.rca}')" class="text-blue-600 hover:text-blue-900 transition-colors">Setează Memento</button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error("Eroare la încărcarea datelor:", error);
                tableBody.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-red-500">Eroare la încărcarea datelor: ${error.message}</td></tr>`;
            }
        };
    </script>
</body>
</html>
